<div align="center">
  <img src="battry.png" alt="Battry Logo" width="30%" />
</div>

## Что это

Battry — нативное меню‑бар приложение для macOS для мониторинга состояния аккумулятора и анализа автономности. Оно собирает историю показаний, визуализирует данные, проводит контролируемый тест разряда, рассчитывает ключевые метрики здоровья батареи и формирует наглядные HTML‑отчёты.

## Возможности

- **Мониторинг в реальном времени**
  - Процент заряда, источник питания (AC/батарея), статус зарядки
  - Температура, напряжение, циклы, паспортная/фактическая ёмкость
  - Корректная работа на устройствах без батареи (Mac mini/Studio)

- **История и графики**
  - Хранение телеметрии в фоне; 7 дней — полная детализация, 7–30 дней — агрегирование (5‑мин бакеты), >30 дней — автоочистка
  - Графики на Swift Charts: заряд %, температура, напряжение, скорость разряда (%/ч)
  - Маркеры событий генератора нагрузки (запуск/остановка CPU и видео)

- **Контролируемый тест (калибровка) автономности**
  - Состояния: idle → waitingFull → running → paused → completed
  - Автостарт при ≥98% и питании от батареи
  - Поддержка генератора нагрузки: **CPU** (профили light/medium/heavy) и опционально **GPU** (воспроизведение 1080p видео)
  - Предотвращение сна системы во время теста
  - Восстановление при перезапуске приложения; авто‑сброс сессии при больших разрывах данных (>30 минут) с уведомлением

- **Охранник безопасности (LoadSafetyGuard)**
  - Автостоп нагрузки при: низком уровне заряда (по умолчанию ≤7%), высокой температуре (>35°C), изменении питания (подключение/зарядка), серьёзном/критическом термодавлении macOS
  - Настройки безопасности применяются автоматически во время теста

- **Аналитика и рекомендации**
  - Средняя и трендовая скорость разряда (%/ч)
  - Оценка автономности (прогноз 100% → 0% в часах)
  - Детекция микро‑просадок (≥2% за ≤120 с без зарядки)
  - Интегральный **Health Score (0–100)** с рекомендациями и списком аномалий

- **HTML‑отчёты**
  - Наглядный отчёт с суммарной оценкой, метриками, аномалиями, графиками (заряд, скорость разряда)
  - Включает сведения о применении генератора нагрузки (профиль, видео)

- **Локализация и доступность**
  - Русский и английский интерфейс, автоопределение языка
  - Полностью офлайн; отсутствует телеметрия

## Требования

- **macOS**: 14.6+
- **Xcode**: 15.0+
- **Swift**: 5.9+
- **Архитектура**: Apple Silicon / Intel

## Установка

- **Скачать готовую сборку**: страница релизов [`Releases`](https://github.com/region23/Battry/releases/latest)
- **Сборка из исходников**
  ```bash
  git clone https://github.com/region23/Battry.git
  cd Battry
  open Battry.xcodeproj
  # В Xcode: ⌘R
  ```

## Как пользоваться

1. Запустите приложение — иконка появится в меню‑баре.
2. Вкладки:
   - **Overview**: краткий срез, ключевые метрики здоровья.
   - **Trends**: графики за последнюю сессию/24ч/7д/30д, переключатели рядов.
   - **Test**: запуск/контроль теста автономности; при желании включите CPU/GPU нагрузку.
   - **Settings**: язык, счётчики и очистка данных.
   - **About**: ссылки и версия.
3. Для теста:
   - Зарядите ноутбук до ≥98%, отключите питание — тест стартует автоматически.
   - При паузе (подключение питания) тест остановится; при повторном ≥98% на батарее — возобновление.
   - По завершении (≤5%) сформируется HTML‑отчёт (кнопка «Открыть отчёт»).
4. Генератор нагрузки (опционально):
   - CPU профиль: light/medium/heavy; автозапуск сессии по настройке.
   - Видео‑нагрузка (GPU) 1080p; при отсутствии файла — безопасный софт‑фоллбек.
   - Охранник безопасности автоматически остановит нагрузку при рисках.

## Где хранятся данные

- `~/Library/Application Support/Battry/history.json` — история измерений
- `~/Library/Application Support/Battry/calibration.json` — состояние/результаты тестов
- `/tmp/Battry_Report_*.html` — отчёты
- Очистка истории и данных анализа — во вкладке `Settings`

## Аналитика: как считаются метрики

- **Скорости разряда**:
  - Средняя: по интервалам без зарядки
  - Трендовая: линейная регрессия (с лёгким медианным сглаживанием)
- **Микро‑просадки**: падение ≥2% за ≤120 с без зарядки (со сглаживанием)
- **Health Score (0–100)**: старт 100 и штрафы
  - Износ: примерно `wear * 1.2`
  - Циклы: при `cycles > 500` — до `-30` (шаг ~ (cycles-500)/10)
  - Температура: если средняя за последний час > 40°C — `-10`
  - Микро‑просадки: `-2` за событие, максимум `-20`
  - Значение ограничивается диапазоном 0…100
- Итог — рекомендация: «Состояние хорошее», «Понаблюдать», «Рекомендуется замена»

## Архитектура (высокоуровнево)

```
IOKit/IORegistry
      │
      ▼
BatteryService ──▶ BatteryViewModel ──▶ HistoryStore
                          │                    │
                          ▼                    ▼
                   CalibrationEngine      AnalyticsEngine
                          │                    │
                          ├─▶ LoadGenerator (CPU)
                          └─▶ LoadSafetyGuard
                          │
                          ▼
                        UI (Overview / Trends / Test / Settings / About)
                          │
                          ▼
                    ReportGenerator (HTML)
```

- **BatteryService**: чтение IOPS + AppleSmartBattery (проценты, мА·ч, циклы, T, V)
- **BatteryViewModel**: Combine‑паблишер, опрос каждые 30с (быстрый режим при ожидании начала теста)
- **HistoryStore**: хранение/тримминг/даунсэмплинг, события для графиков
- **CalibrationEngine**: автоматическое управление сессией, предотвращение сна, авто‑сброс при больших разрывах, история последних 5 результатов
- **LoadGenerator**: профили нагрузки; безопасные ограничения
- **LoadSafetyGuard**: автостоп по порогам и сигналам системы
- **ReportGenerator**: статический HTML с векторными графиками и суммарными карточками
- **UI**: SwiftUI + Charts, локализация (RU/EN)

## Конфиденциальность и безопасность

- **Локальная обработка**: все данные остаются на устройстве
- **Нулевая телеметрия**: сеть не используется
- **Минимальные разрешения**: только системные API (SwiftUI, IOKit, AVFoundation, Charts, Combine)
- **Sandbox** и открытый код — для аудита сообществом

## Известные ограничения

- Доступность датчиков (напряжение/температура) зависит от модели устройства
- Оценки времени macOS (TimeToEmpty/Full) могут быть нестабильны на старых моделях
- Точность аналитики повышается с длиной сессии и числом точек без зарядки
- На устройствах без батареи функциональность ограничена

## Дорожная карта

- **Коротко**: настраиваемые интервалы опроса; уведомления (температура/аномалии); экспорт CSV/JSON; темы (тёмная/светлая)
- **Среднесрочно**: профили нескольких устройств; пользовательские пороги; интеграция с Shortcuts; автозапуск (Login Items)
- **Долго**: ML‑прогнозы; бенчмарки по моделям; девелоперское API; опциональная зашифрованная синхронизация

## Участие

1. Fork репозитория
2. Ветка: `git checkout -b feature/your-feature`
3. Коммиты: `git commit -m "Add: your feature"`
4. Push и Pull Request с описанием

## Лицензия

MIT 