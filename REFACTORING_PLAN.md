## План рефакторинга и внедрения встроенного генератора нагрузки (Battry)

### Цели
- **Прозрачное здоровье батареи (SoH)**: SoH = FCC / DesignCapacity × 100%, показ FCC/Design/Cycles/Temp, статусы и ориентиры.
- **Воспроизводимый разрядной тест**: встроенный «генератор нагрузки» с профилями CPU/Видео/Комбо, автологирование и авто‑стопы.
- **Калибровочный мастер и контроль условий**: префлайт проверки (температура, питание, офлайн, яркость ≈50%).
- **Отчёты и история**: фиксировать параметры теста, сохранять результаты и отчёты с флагами аномалий.

### Область изменений (высокоуровнево)
- Добавить модуль генератора нагрузки с профилями и безопасными ограничителями.
- Интегрировать генератор в текущий **CalibrationEngine/CalibrationPanel** без ломки истории.
- Показать SoH и статусы в **MenuContent** (Overview) и учитывать в аналитике (**AnalyticsEngine** уже частично готов).
- Обновить отчёты: фиксировать профиль/режим теста.
- Локализация RU/EN для новых строк.

---

### Архитектура и новые компоненты
- `LoadGenerator.swift` (новый)
  - Класс `LoadGenerator` с API:
    - `start(profile: LoadProfile, options: LoadOptions)`
    - `stop()`
    - Безопасная блокировка сна: `ProcessInfo.beginActivity(.idleSystemSleepDisabled)` (только при активном тесте и если разрешено в настройках).
  - Внутри: набор `DispatchSourceTimer` по числу рабочих потоков с duty cycle (спин + пауза) для CPU‑нагрузки.
  - Поддержка QoS `.utility` для стабильности (минимизировать «дрожание» нагрузки).

- `LoadProfile` (новый)
  - Преднастройки:
    - `.light`: 1 поток, duty 25%, период 100 мс.
    - `.medium`: 2 потока, duty 50%, период 100 мс.
    - `.heavy`: `activeProcessorCount` потоков, duty 80%, период 50 мс.
  - Фабрика для произвольного профиля из значения «CPU %» (слайдер): маппинг процента в `(threads, duty)`.

- `VideoLoadEngine` (новый)
  - `AVQueuePlayer` + `AVPlayerLooper` для локального файла `sample_1080p_h264.mp4` (в бандле), без звука.
  - API: `start()` / `stop()`; работает и свернутым (вью опциональна).

- `LoadSafetyGuard` (новый, легковесный)
  - Подписка на `BatteryViewModel.publisher` и мониторинг `ProcessInfo.processInfo.thermalState`.
  - Условия авто‑стопа генератора:
    - Батарея ≤ 7%.
    - Температура ≥ 35 °C (порог настраиваемый).
    - Термосостояние `.serious`/`.critical`.
    - Питание от сети/зарядка.

---

### Интеграция с существующим кодом
- `BattryApp.swift`
  - Создать `@StateObject private var loadGenerator = LoadGenerator()` и (опционально) `@StateObject private var videoLoad = VideoLoadEngine()`.
  - Пробросить зависимости в `MenuContent`/`CalibrationPanel` через environment или параметры.

- `CalibrationEngine.swift`
  - При переходе в `.running` запускать генератор при включенной опции «Автозапуск генератора» и выбранном профиле.
  - При переходе в `.paused`/`.completed`/`.idle` всегда останавливать генератор.
  - Добавить делегат/колбэк для уведомления UI о статусе генератора (или публиковать через `@Published`).

- `CalibrationPanel.swift`
  - Секция «Генератор нагрузки» в `idle` и `running` состояниях:
    - Тумблер «Включить генератор».
    - Селектор профиля: Light / Medium / Heavy.
    - Доп. опция: «Воспроизводить 1080p‑видео» (отдельный тумблер).
    - Чип‑индикатор состояния и авто‑стопов (например, «остановлен из‑за температуры 36.2 °C»).
  - При `running`: показывать текущий профиль, кнопку «Пауза генератора» (не останавливая тест).

- `ChartsPanel.swift`
  - Ничего критичного: опционально добавить маркеры интервалов «генератор активен» (если будет простая телеметрия событий).

- `HistoryStore.swift`
  - Схему не ломать. Опционально: ввести лёгкие событийные маркеры без изменения `BatteryReading` — отдельный in‑memory список (необязательный P2+).

- `MenuContent.swift`
  - В «Overview» дополнить карточку: SoH (FCC/Design) и статус по ориентирам (≥90 отлично, 80–90 норм, <80 внимание).
  - Иконка/бейдж «Тест активен» уже есть; добавить бейдж «Генератор активен» (необязательно, P2).

- `AnalyticsEngine.swift`
  - Учесть SoH (через `BatterySnapshot.wearPercent` уже есть) — настройки порогов остаются прежними.
  - В отчёт отдавать флаг «генератор включен / профиль / видео».

- `ReportGenerator.swift`
  - Вставить в шапку отчёта блок: профиль нагрузки, видео‑режим, авто‑стоп причины.

---

### Локализация
- Добавить ключи в `en.lproj/Localizable.strings` и `ru.lproj/Localizable.strings`:
  - Заголовки: "Генератор нагрузки", "Профиль", "Лёгкий/Средний/Тяжёлый", "Видео 1080p", "Автозапуск".
  - Сообщения авто‑стопов: «Остановлено по температуре %@°C», «Остановлено при заряде %@%%», «Остановлено: подключено питание», «Остановлено: перегрев (терм. %@)».
  - SoH: «Здоровье (SoH)», «Ёмкость фактическая/паспортная», «Отлично/Норма/Внимание».

---

### Безопасность и стабильность
- Авто‑стопы по условиям (см. `LoadSafetyGuard`).
- Пределы duty/threads: жёсткие лимиты, чтобы не допустить 100% длительно.
- QoS `.utility`, без приоритета `.userInteractive`.
- Блокировка сна только при активном тесте и включенной настройке.

---

### Тестовые профили (дефолт)
- `.light`: комфортный фоновый.
- `.medium`: рекомендованный воспроизводимый (по умолчанию) + опция видео.
- `.heavy`: стресс‑профиль (включать вручную, предупреждение в UI).

---

### Порядок работ (итерациями)
1) P0 — SoH и статусы в Overview
   - Показ: FCC (`maxCapacity`), Design, Cycles, SoH%.
   - Цветовая индикация по ориентирам.

2) P1 — Генератор нагрузки (CPU) + безопасные авто‑стопы
   - Реализация `LoadGenerator.swift`, `LoadSafetyGuard`.
   - UI в `CalibrationPanel`: тумблер, выбор профиля, автозапуск.
   - Связка с `CalibrationEngine` (старт/стоп по состояниям).

3) P2 — Видео‑нагрузка и комбинированный режим
   - `VideoLoadEngine`: локальный файл, `AVPlayerLooper`.
   - UI тумблер «Видео 1080p».
   - Отображение статуса.

4) P3 — Отчёты и маркеры генератора
   - Вставить выбор профиля/видео в `ReportGenerator`.
   - (Опционально) события «генератор активен» для графика.

5) P4 — Улучшения префлайта/мастера
   - Проверки условий теста (температура, питание, сети, яркость — подсказка).
   - Ненавязчивые напоминания/советы.

---

### Критерии готовности (DoD)
- Генератор CPU стабильно держит нагрузку по профилям, без рывков и утечек.
- Авто‑стопы срабатывают и отображают понятную причину.
- Тест разряда можно провести «в один клик»: старт → генератор → лог → финиш ≤ 7%.
- SoH и ориентиры отображаются корректно; расчёт консистентен с `ioreg`.
- Отчёт содержит профиль нагрузки и метаданные теста.
- Локализации RU/EN добавлены; UI не ломается при переключении языка.

---

### Изменения по файлам (детализация)
- Добавить: `Battry/LoadGenerator.swift`
  - `final class LoadGenerator` с `Profile`, `start/stop`, duty‑циклом, QoS.

- Добавить: `Battry/VideoLoadEngine.swift`
  - `final class VideoLoadEngine` с `AVQueuePlayer` + `AVPlayerLooper`.

- Добавить: `Battry/LoadSafetyGuard.swift`
  - Подписка на снимки, правила авто‑стопа.

- Изменить: `Battry/BattryApp.swift`
  - Инстансы генератора/видео/гуарда; проброс в UI; tidy‑lifecycle.

- Изменить: `Battry/CalibrationEngine.swift`
  - Хуки на `state` для start/stop генератора, публикация статуса.

- Изменить: `Battry/CalibrationPanel.swift`
  - UI секция «Генератор нагрузки»: тумблер, профили, видео, индикация.

- Изменить: `Battry/MenuContent.swift`
  - Overview: SoH бейдж/значение; (опц.) бейдж генератора.

- Изменить: `Battry/ReportGenerator.swift`
  - Вставка метаданных генератора в отчёт.

- Изменить: `Battry/Localization.strings` + `en.lproj/ru.lproj/Localizable.strings`
  - Новые ключи строк.

---

### UX/копирайт
- В предупреждениях пояснить, что генератор не «лечит» батарею, а стабилизирует условия разряда для оценки.
- Для профиля Heavy показать предупреждение об интенсивном нагреве.
- Подсказка: для максимальной воспроизводимости — офлайн, 50% яркость, закрыть тяжёлые процессы.

---

### Оценка рисков
- Долгая тяжёлая нагрузка → нагрев: смягчено авто‑стопами.
- Видео‑файл в бандле увеличит размер приложения: выбрать клип 20–30 с, 1080p H.264, ~2–5 МБ.
- Изменения UI: держать фичу под настройкой и аккуратно встраивать в существующие карточки.

---

### Наметка API (эскиз, для согласования)
```swift
// LoadGenerator.swift
final class LoadGenerator: ObservableObject {
    struct Profile { let workerThreads: Int; let dutyCycle: Double; let periodSeconds: Double }
    enum Preset { case light, medium, heavy }
    func start(profile: Profile) {}
    func stop() {}
}

extension LoadGenerator.Preset {
    var profile: LoadGenerator.Profile { /* map to concrete values */ }
}

// VideoLoadEngine.swift
final class VideoLoadEngine: ObservableObject { func start() {}; func stop() {} }

// LoadSafetyGuard.swift
final class LoadSafetyGuard {
    init(batteryPublisher: PassthroughSubject<BatterySnapshot, Never>, stop: @escaping () -> Void) {}
}
```

---

### Релиз по шагам
- v1: CPU‑генератор + авто‑стопы + базовый UI.
- v2: Видео + комбинированный режим + отчёт с метаданными.
- v3: Маркеры на графике + расширенный префлайт + подсказки.

---

### Замечания по совместимости
- История (`HistoryStore`) не меняется → миграций не требуется.
- Новые файлы не ломают существующую аналитику; отчёт дополняется метаданными.

---

Готов к реализации P1 (CPU‑генератор с профилями) сразу после утверждения этого плана.


